name: Reusable Notifications

on:
  workflow_call:
    inputs:
      channel:
        required: true
        type: string        # discord | email
      status:
        required: true
        type: string        # success | failure
      event_type:
        required: true
        type: string        # ci | deploy
      environment:
        required: false
        type: string
    secrets:
      DISCORD_WEBHOOK_URL:
        required: false
      EMAIL_USER:
        required: false
      EMAIL_PASS:
        required: false
      EMAIL_TO:
        required: false

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Set dynamic message
        id: msg
        run: |
          BRANCH="${GITHUB_REF_NAME}"
          COMMIT_MSG="$(git log -1 --pretty=%B)"

          if [ "$BRANCH" = "main" ]; then
            CONTEXT="Main branch"
          else
            CONTEXT="Feature branch ($BRANCH)"
          fi

          if [ "${{ inputs.event_type }}" = "deploy" ]; then
            TITLE="ðŸš€ Production deployment ${{ inputs.status }}"
          else
            TITLE="ðŸ§ª CI pipeline ${{ inputs.status }}"
          fi

          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "context=$CONTEXT" >> $GITHUB_OUTPUT
          echo "commit=$COMMIT_MSG" >> $GITHUB_OUTPUT

      - name: Discord notification
        if: inputs.channel == 'discord'
        uses: Ilshidur/action-discord@v2
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        with:
          args: |
            **${{ steps.msg.outputs.title }}**
            **Context:** ${{ steps.msg.outputs.context }}

            **Repository:** ${{ github.repository }}
            **Branch:** ${{ github.ref_name }}
            **Commit:** ${{ github.sha }}
            **Message:** ${{ steps.msg.outputs.commit }}
            **Actor:** ${{ github.actor }}

      - name: Email notification
        if: inputs.channel == 'email'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USER }}
          password: ${{ secrets.EMAIL_PASS }}
          to: ${{ secrets.EMAIL_TO }}
          from: GitHub CI
          subject: "${{ steps.msg.outputs.title }}"
          body: |
            Context: ${{ steps.msg.outputs.context }}
            Repository: ${{ github.repository }}
            Environment: ${{ inputs.environment }}
            Branch: ${{ github.ref_name }}
            Commit: ${{ github.sha }}
            Commit message: ${{ steps.msg.outputs.commit }}
            Triggered by: ${{ github.actor }}
            Status: ${{ inputs.status }}

            Please review the GitHub Actions logs.
