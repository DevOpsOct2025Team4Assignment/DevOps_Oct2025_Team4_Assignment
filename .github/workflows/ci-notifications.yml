name: Main Release Pipeline

on:
  push:
    branches: [ "main" ]
  release:
    types: [published]

jobs:
  ci:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Run Production Unit Tests
        run: |
          echo "Running production-level tests..."
          # Change to 'assert 1 == 2' to test a failure notification
          python3 -c "assert 1 == 1"

  notify-main:
    runs-on: ubuntu-latest
    needs: [ci]
    if: always()
    steps:
      - name: Send Discord Notification
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
          CI_RESULT: ${{ needs.ci.result }}
          # Updated to your new Role ID
          MAIN_ROLE_ID: "1460616737648148594"
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          COMMIT_SHA: ${{ github.sha }}
          EVENT_NAME: ${{ github.event_name }}
          RELEASE_TAG: ${{ github.event.release.tag_name }}
          COMMIT_MSG: ${{ github.event.head_commit.message || github.event.release.name }}
        run: |
          python3 - << 'EOF'
          import urllib.request
          import json
          import os

          def send_discord():
              webhook_url = os.getenv('DISCORD_WEBHOOK')
              status = os.getenv('CI_RESULT')
              role_id = os.getenv('MAIN_ROLE_ID')
              repo = os.getenv('GITHUB_REPOSITORY')
              branch = os.getenv('GITHUB_REF_NAME')
              run_id = os.getenv('GITHUB_RUN_ID')
              event = os.getenv('EVENT_NAME')
              tag = os.getenv('RELEASE_TAG')
              sha = os.getenv('COMMIT_SHA', '0000000')[:7]
              msg = os.getenv('COMMIT_MSG', 'Main Update').split('\n')[0]

              if not webhook_url:
                  print("‚ùå Webhook URL missing")
                  return

              # Determine Context (Release vs Push to Main)
              context = f"Release `{tag}`" if event == 'release' else f"Branch `{branch}`"
              log_url = f"https://github.com/{repo}/actions/runs/{run_id}"
              
              if status == 'failure':
                  header = f"üö® *Tests failed in* {context}"
                  # Pinging the new role ID on failure
                  footer = f"View logs <@&{role_id}>"
                  color = 15158332 # Red
              else:
                  header = f"‚úÖ *Tests passed in* {context}"
                  footer = "View logs"
                  color = 3066993 # Green

              content = f"{header}\n\n`{sha}` {msg}\n\n{footer}"

              payload = {
                  "content": content,
                  "embeds": [{
                      "description": f"[Open Workflow Details]({log_url})",
                      "color": color
                  }]
              }

              req = urllib.request.Request(
                  webhook_url, 
                  data=json.dumps(payload).encode('utf-8'), 
                  headers={'Content-Type': 'application/json', 'User-Agent': 'Mozilla/5.0'}
              )
              
              try:
                  with urllib.request.urlopen(req) as resp:
                      print(f"Notification Sent: {resp.status}")
              except Exception as e:
                  print(f"‚ùå Error: {e}")

          if __name__ == "__main__":
              send_discord()
          EOF