name: Developer CI Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "**" ]

jobs:
  ci:
    runs-on: ubuntu-latest
    # We create an output so the next job knows for sure if tests passed or failed
    outputs:
      test_result: ${{ steps.run_tests.outcome }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Create Unsuccessful Unit Test
        run: |
          echo "def test_fail(): assert 1 == 2" > test_mock.py

      - name: Run Unit Tests
        id: run_tests
        continue-on-error: true  # This is the key fix
        run: |
          python3 -m pytest test_mock.py

  notify-devs:
    runs-on: ubuntu-latest
    needs: [ci]
    if: always() 
    steps:
      - name: Send Discord Notification
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_DEV_WEBHOOK_URL }}
          # We check the specific outcome of the test step
          CI_RESULT: ${{ needs.ci.outputs.test_result }}
          DEV_ROLE_ID: "1461638107211235401"
          COMMIT_SHA: ${{ github.sha }}
          COMMIT_MSG: ${{ github.event.head_commit.message || github.event.pull_request.title }}
          REPO: ${{ github.repository }}
          RUN_ID: ${{ github.run_id }}
          BRANCH: ${{ github.ref_name }}
        run: |
          python3 - << 'EOF'
          import urllib.request
          import json
          import os

          def send_discord():
              webhook_url = os.getenv('DISCORD_WEBHOOK')
              # outcome will be 'failure' or 'success'
              status = os.getenv('CI_RESULT')
              role_id = os.getenv('DEV_ROLE_ID')
              branch = os.getenv('BRANCH')
              repo = os.getenv('REPO')
              run_id = os.getenv('RUN_ID')
              
              short_sha = os.getenv('COMMIT_SHA', '0000000')[:7]
              commit_msg = os.getenv('COMMIT_MSG', 'Manual Update').split('\n')[0]
              log_url = f"https://github.com/{repo}/actions/runs/{run_id}"

              if status == 'failure':
                  header = f"ðŸš¨ *Tests failed in* `{branch}`"
                  footer = f"View logs <@&{role_id}>"
                  color = 15158332 
              else:
                  header = f"âœ… *Tests passed in* `{branch}`"
                  footer = f"View logs"
                  color = 3066993 

              content = f"{header}\n\n`{short_sha}` {commit_msg}\n\n{footer}"

              payload = {
                  "content": content,
                  "embeds": [{"url": log_url, "color": color}]
              }

              req = urllib.request.Request(webhook_url, data=json.dumps(payload).encode('utf-8'), 
                                           headers={'Content-Type': 'application/json'})
              try:
                  with urllib.request.urlopen(req) as response:
                      print(f"Sent: {response.status}")
              except Exception as e:
                  print(f"Error: {e}")

          if __name__ == "__main__":
              send_discord()
          EOF