name: Developer CI Pipeline

on:
  push:
    branches: [ "**" ]  # Triggers on every branch
  pull_request:
    branches: [ "**" ]

jobs:
  # Job 1: Build/Test Simulation
  ci:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Run Build Logic
        run: |
          echo "Simulating build and environment setup..."
          # To test a FAILURE: uncomment the line below
           exit 1 
          echo "‚úÖ Build simulation successful."

  # Job 2: Discord Notification (Pure Python - No dependencies)
  notify-devs:
    runs-on: ubuntu-latest
    needs: [ci]
    if: always() # Ensures it runs on both Success and Failure
    steps:
      - name: Send Discord Notification
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_DEV_WEBHOOK_URL }}
          CI_RESULT: ${{ needs.ci.result }}
          DEV_ROLE_ID: "1461638107211235401"
        run: |
          python3 - << 'EOF'
          import urllib.request
          import json
          import os

          def send_discord():
              webhook_url = os.getenv('DISCORD_WEBHOOK')
              status = os.getenv('CI_RESULT')
              role_id = os.getenv('DEV_ROLE_ID')
              repo = os.getenv('GITHUB_REPOSITORY')
              branch = os.getenv('GITHUB_REF_NAME')
              run_id = os.getenv('GITHUB_RUN_ID')

              if not webhook_url:
                  print("‚ùå Error: DISCORD_DEV_WEBHOOK_URL secret is missing.")
                  return

              # Logic for Failure vs Success
              if status == 'failure':
                  content = f"üö® **BUILD FAILED** üö®\nAttention <@&{role_id}>: A break occurred on branch `{branch}`."
                  color = 15158332 # Red
              else:
                  content = f"‚úÖ **BUILD PASSED**\nBranch `{branch}` is stable."
                  color = 3066993 # Green

              payload = {
                  "content": content if status == 'failure' else None,
                  "embeds": [{
                      "title": f"CI Pipeline Result: {status.upper()}",
                      "description": f"**Repo:** {repo}\n**Branch:** {branch}\n[View Logs](https://github.com/{repo}/actions/runs/{run_id})",
                      "color": color
                  }]
              }

              req = urllib.request.Request(webhook_url, data=json.dumps(payload).encode('utf-8'), 
                                           headers={'Content-Type': 'application/json', 'User-Agent': 'Mozilla/5.0'})
              
              try:
                  with urllib.request.urlopen(req) as response:
                      print(f"Status: {response.status}")
              except Exception as e:
                  print(f"‚ùå Failed to send Discord alert: {e}")

          if __name__ == "__main__":
              send_discord()
          EOF