name: IAST - Code & Runtime Security Analysis

on:
  push:
    branches: [ main, master, development ]
  pull_request:
    branches: [ main, master, development ]

permissions:
  contents: read
  security-events: write

jobs:
  iast:
    name: IAST Security Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install bandit safety pylint
      
      - name: Bandit Security Analysis
        run: |
          bandit -r app/ -f json -o bandit-report.json || true
          echo "Bandit scan complete"
        continue-on-error: true
      
      - name: Safety Dependency Check
        run: |
          safety check --json > safety-report.json || true
          echo "Safety scan complete"
        continue-on-error: true
      
      - name: Pylint Code Analysis
        run: |
          pylint app/ --output-format=json > pylint-report.json || true
          echo "Pylint analysis complete"
        continue-on-error: true
      
      - name: Initialize database
        run: |
          rm -f instance/app.db
          python -m flask init-db
        env:
          FLASK_APP: app
      
      - name: Start Flask application
        run: |
          export FLASK_APP=app
          nohup flask run &
          sleep 5
          echo "Application started"
      
      - name: Run integration tests
        run: pytest tests/ -v --tb=short -x || true
        env:
          FLASK_APP: app
        continue-on-error: true
      
      - name: Upload Bandit report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: bandit-security-report
          path: bandit-report.json
      
      - name: Upload Safety report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: safety-dependency-report
          path: safety-report.json
      
      - name: Upload Pylint report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pylint-code-analysis
          path: pylint-report.json
      
      - name: Security Summary
        run: |
          echo "=== IAST Security Analysis Summary ==="
          echo "Bandit Report:"
          python -m json.tool bandit-report.json | head -50 || echo "No issues"
          echo ""
          echo "Safety Report:"
          python -m json.tool safety-report.json | head -50 || echo "No vulnerable dependencies"
        if: always()