name: CI Pipeline

on:
  push:
    branches: [ "**" ]
  pull_request:
    branches: [ "**" ]

jobs:
  # Job 1: Build and Test (Pure Python)
  ci:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Run Tests
        run: |
          # Replace 'python -m unittest' with 'pytest' if you use pytest
          python -m unittest discover tests/

  # Job 2: Deployment
  deploy:
    runs-on: ubuntu-latest
    needs: ci
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4
      - name: Execute Deployment
        run: |
          echo "ðŸš€ Deploying Python Application..."
          # Example: python setup.py sdist bdist_wheel
          echo "âœ… Deployment logic completed."

  # Job 3: Notification (Pure Python Standard Library)
  notify:
    runs-on: ubuntu-latest
    needs: [ci]
    if: always() 
    steps:
      - name: Python Email Dispatcher
        env:
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
          EMAIL_TO: ${{ secrets.EMAIL_TO }}
          CI_RESULT: ${{ needs.ci.result }}
        run: |
          python3 - << 'EOF'
          import smtplib
          import os
          from email.message import EmailMessage

          def send_notification():
              user = os.getenv('EMAIL_USER')
              password = os.getenv('EMAIL_PASS')
              recipient = os.getenv('EMAIL_TO')
              status = os.getenv('CI_RESULT')
              repo = os.getenv('GITHUB_REPOSITORY')
              run_id = os.getenv('GITHUB_RUN_ID')

              if not all([user, password, recipient]):
                  print("âŒ Error: Missing secrets.")
                  return

              icon = "âœ…" if status == "success" else "âŒ"
              msg = EmailMessage()
              msg['Subject'] = f"{icon} Python CI Alert: {repo}"
              msg['From'] = user
              msg['To'] = recipient
              
              msg.set_content(
                  f"Repository: {repo}\n"
                  f"Result: {status.upper()}\n"
                  f"Logs: https://github.com/{repo}/actions/runs/{run_id}"
              )

              try:
                  with smtplib.SMTP('smtp.gmail.com', 587) as server:
                      server.starttls()
                      server.login(user, password)
                      server.send_message(msg)
                  print("âœ… Email sent.")
              except Exception as e:
                  print(f"âŒ Error: {e}")

          if __name__ == "__main__":
              send_notification()
          EOF