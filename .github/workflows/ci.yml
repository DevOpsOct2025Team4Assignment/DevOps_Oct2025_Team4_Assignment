# .github/workflows/ci.yml
name: CI and Deploy Pipeline

on:
  push:
    branches: ["**"]
  pull_request:

jobs:
  ci:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

  deploy:
    runs-on: ubuntu-latest
    environment: production
    needs: ci
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Deploy
        run: ./deploy.sh

  # --- Email Notification: CI Success ---
  notify-ci-success:
    if: success() && !cancelled()
    needs: ci
    runs-on: ubuntu-latest
    steps:
      - name: Send success email (CI)
        env:
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
          EMAIL_TO: ${{ secrets.EMAIL_TO }}
          GITHUB_REF: ${{ github.ref }}
          GITHUB_EVENT: ${{ github.event_name }}
          GITHUB_SHA: ${{ github.sha }}
        run: |
          npm install nodemailer
          node -e "
            const nodemailer = require('nodemailer');
            const transporter = nodemailer.createTransport({
              host: 'smtp.gmail.com',
              port: 587,
              secure: false,
              auth: { user: process.env.EMAIL_USER, pass: process.env.EMAIL_PASS }
            });
            const branch = process.env.GITHUB_REF.replace('refs/heads/', '');
            const subject = \`✅ CI Succeeded on \${branch} (\${process.env.GITHUB_EVENT})\`;
            const text = \`Build succeeded for commit \${process.env.GITHUB_SHA} on branch \${branch}.\n\nWorkflow: ${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID}\`;
            transporter.sendMail({
              from: process.env.EMAIL_USER,
              to: process.env.EMAIL_TO,
              subject: subject,
              text: text
            }).then(() => console.log('Success email sent')).catch(console.error);
          "

  # --- Email Notification: CI Failure ---
  notify-ci-failure:
    if: failure()
    needs: ci
    runs-on: ubuntu-latest
    steps:
      - name: Send failure email (CI)
        env:
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
          EMAIL_TO: ${{ secrets.EMAIL_TO }}
          GITHUB_REF: ${{ github.ref }}
          GITHUB_EVENT: ${{ github.event_name }}
          GITHUB_SHA: ${{ github.sha }}
        run: |
          npm install nodemailer
          node -e "
            const nodemailer = require('nodemailer');
            const transporter = nodemailer.createTransport({
              host: 'smtp.gmail.com',
              port: 587,
              secure: false,
              auth: { user: process.env.EMAIL_USER, pass: process.env.EMAIL_PASS }
            });
            const branch = process.env.GITHUB_REF.replace('refs/heads/', '');
            const subject = \`❌ CI Failed on \${branch} (\${process.env.GITHUB_EVENT})\`;
            const text = \`Build failed for commit \${process.env.GITHUB_SHA} on branch \${branch}.\n\nWorkflow: ${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID}\`;
            transporter.sendMail({
              from: process.env.EMAIL_USER,
              to: process.env.EMAIL_TO,
              subject: subject,
              text: text
            }).then(() => console.log('Failure email sent')).catch(console.error);
          "

  # --- Email Notification: Deploy Success ---
  notify-deploy-success:
    if: success() && !cancelled()
    needs: deploy
    runs-on: ubuntu-latest
    steps:
      - name: Send success email (Deploy)
        env:
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
          EMAIL_TO: ${{ secrets.EMAIL_TO }}
          GITHUB_SHA: ${{ github.sha }}
        run: |
          npm install nodemailer
          node -e "
            const nodemailer = require('nodemailer');
            const transporter = nodemailer.createTransport({
              host: 'smtp.gmail.com',
              port: 587,
              secure: false,
              auth: { user: process.env.EMAIL_USER, pass: process.env.EMAIL_PASS }
            });
            const subject = '✅ Production Deploy Succeeded';
            const text = \`Successfully deployed commit \${process.env.GITHUB_SHA} to production.\n\nWorkflow: ${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID}\`;
            transporter.sendMail({
              from: process.env.EMAIL_USER,
              to: process.env.EMAIL_TO,
              subject: subject,
              text: text
            }).then(() => console.log('Deploy success email sent')).catch(console.error);
          "

  # --- Email Notification: Deploy Failure ---
  notify-deploy-failure:
    if: failure()
    needs: deploy
    runs-on: ubuntu-latest
    steps:
      - name: Send failure email (Deploy)
        env:
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
          EMAIL_TO: ${{ secrets.EMAIL_TO }}
          GITHUB_SHA: ${{ github.sha }}
        run: |
          npm install nodemailer
          node -e "
            const nodemailer = require('nodemailer');
            const transporter = nodemailer.createTransport({
              host: 'smtp.gmail.com',
              port: 587,
              secure: false,
              auth: { user: process.env.EMAIL_USER, pass: process.env.EMAIL_PASS }
            });
            const subject = '❌ Production Deploy Failed';
            const text = \`Deployment failed for commit \${process.env.GITHUB_SHA}.\n\nWorkflow: ${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID}\`;
            transporter.sendMail({
              from: process.env.EMAIL_USER,
              to: process.env.EMAIL_TO,
              subject: subject,
              text: text
            }).then(() => console.log('Deploy failure email sent')).catch(console.error);
          "